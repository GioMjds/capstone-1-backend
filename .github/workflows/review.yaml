name: Pull Request Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - 'test/**'
      - 'prisma/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - '.env.example'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm lint
        continue-on-error: true

      - name: Run Prettier check
        run: pnpm prettier --check "src/**/*.ts" "test/**/*.ts"
        continue-on-error: true

      - name: TypeScript type checking
        run: pnpm tsc --noEmit
        continue-on-error: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run dependency audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma generate

      - name: Build application
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
        run: |
          pnpm prisma migrate deploy
          pnpm prisma generate

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
        run: pnpm test --coverage

      - name: Run e2e tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
        run: pnpm test:e2e

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  prisma-validation:
    name: Prisma Schema Validation
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'prisma/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate Prisma schema
        run: pnpm prisma validate

      - name: Check migration status
        run: pnpm prisma migrate status || true

      - name: Generate Prisma Client
        run: pnpm prisma generate

  code-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for console.log statements
        id: console-check
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD -- 'src/**/*.ts' | grep -E '^\+.*console\.(log|debug|info|warn)'; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "âŒ Found console.log statements in code" >> $GITHUB_STEP_SUMMARY
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âœ… No console.log statements found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check for TODO/FIXME comments
        id: todo-check
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD -- 'src/**/*.ts' | grep -E '^\+.*(TODO|FIXME)'; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Found TODO/FIXME comments in code" >> $GITHUB_STEP_SUMMARY
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âœ… No TODO/FIXME comments found" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check for hardcoded credentials
        id: credentials-check
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD -- 'src/**/*.ts' | grep -iE '^\+.*(password|api_key|secret|token).*=.*("|'"'"')'; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Potential hardcoded credentials detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âœ… No hardcoded credentials detected" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check file sizes
        id: file-size-check
        run: |
          large_files=$(find src -name "*.ts" -size +300k)
          if [ -n "$large_files" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Found files larger than 300 lines:" >> $GITHUB_STEP_SUMMARY
            echo "$large_files" >> $GITHUB_STEP_SUMMARY
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âœ… All files within size limits" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Comment on PR with review results
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comments = [];
            
            if ('${{ steps.console-check.outputs.found }}' === 'true') {
              comments.push('âŒ **Console Statements Found**: Please remove console.log statements before merging.');
            }
            
            if ('${{ steps.todo-check.outputs.found }}' === 'true') {
              comments.push('âš ï¸ **TODO/FIXME Comments**: Consider addressing or creating issues for TODO/FIXME comments.');
            }
            
            if ('${{ steps.credentials-check.outputs.found }}' === 'true') {
              comments.push('ðŸš¨ **Security Alert**: Potential hardcoded credentials detected. Please review immediately.');
            }
            
            if ('${{ steps.file-size-check.outputs.found }}' === 'true') {
              comments.push('âš ï¸ **Large Files**: Some files exceed recommended size limits. Consider refactoring.');
            }
            
            if (comments.length > 0) {
              const body = `## ðŸ¤– Automated Code Review\n\n${comments.join('\n\n')}\n\n---\n*This is an automated review. Please address the issues above.*`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  changes-summary:
    name: PR Changes Summary
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changes summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            
            const stats = execSync('git diff --stat origin/${{ github.base_ref }}...HEAD').toString();
            const filesChanged = execSync('git diff --name-only origin/${{ github.base_ref }}...HEAD').toString().split('\n').filter(f => f);
            
            const categories = {
              'Source Code': filesChanged.filter(f => f.startsWith('src/')),
              'Tests': filesChanged.filter(f => f.startsWith('test/')),
              'Database': filesChanged.filter(f => f.startsWith('prisma/')),
              'Configuration': filesChanged.filter(f => f.match(/\.(json|yaml|yml|config\.[jt]s)$/)),
              'Documentation': filesChanged.filter(f => f.endsWith('.md'))
            };
            
            let summary = '## ðŸ“Š Changes Summary\n\n';
            summary += '```\n' + stats + '\n```\n\n';
            summary += '### Files Changed by Category\n\n';
            
            for (const [category, files] of Object.entries(categories)) {
              if (files.length > 0) {
                summary += `**${category}** (${files.length} file${files.length > 1 ? 's' : ''})\n`;
                files.slice(0, 10).forEach(f => summary += `- \`${f}\`\n`);
                if (files.length > 10) summary += `- ... and ${files.length - 10} more\n`;
                summary += '\n';
              }
            }
            
            core.summary.addRaw(summary).write();

  review-checklist:
    name: Review Checklist
    runs-on: ubuntu-latest
    
    steps:
      - name: Post review checklist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const checklist = `
            ## âœ… Review Checklist
            
            Please ensure the following before merging:
            
            ### Code Quality
            - [ ] Code follows project standards and conventions
            - [ ] No commented-out code blocks
            - [ ] No console.log or debugging statements
            - [ ] No TODO/FIXME comments without corresponding issues
            - [ ] Functions and variables have descriptive names
            - [ ] Files are under 300 lines (when possible)
            
            ### Security
            - [ ] No hardcoded credentials or secrets
            - [ ] Input validation is present where needed
            - [ ] Authentication/authorization checks are in place
            - [ ] Error messages don't expose sensitive information
            
            ### Testing
            - [ ] Unit tests pass
            - [ ] E2E tests pass (if applicable)
            - [ ] New features have corresponding tests
            - [ ] Edge cases are covered
            
            ### Database
            - [ ] Prisma schema is valid
            - [ ] Migrations are properly named and tested
            - [ ] No data loss in migrations
            - [ ] Database indexes are appropriate
            
            ### Documentation
            - [ ] README updated if needed
            - [ ] API documentation updated if applicable
            - [ ] Breaking changes are documented
            - [ ] Migration notes added if needed
            
            ### Performance
            - [ ] No N+1 query problems
            - [ ] Appropriate use of database indexes
            - [ ] Large datasets are paginated
            - [ ] No unnecessary database calls
            
            ---
            *Automated checks will verify some of these items.*
            `;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('Review Checklist')
            );
            
            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: checklist
              });
            }

  status-check:
    name: Overall Status
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, build, test, prisma-validation]
    if: always()
    
    steps:
      - name: Check all jobs status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jobs = [
              { name: 'Code Quality', status: '${{ needs.code-quality.result }}' },
              { name: 'Security Scan', status: '${{ needs.security-scan.result }}' },
              { name: 'Build', status: '${{ needs.build.result }}' },
              { name: 'Tests', status: '${{ needs.test.result }}' },
              { name: 'Prisma Validation', status: '${{ needs.prisma-validation.result }}' }
            ];
            
            const failed = jobs.filter(j => j.status === 'failure');
            const passed = jobs.filter(j => j.status === 'success');
            const skipped = jobs.filter(j => j.status === 'skipped');
            
            let summary = '## ðŸŽ¯ PR Review Status\n\n';
            summary += `âœ… Passed: ${passed.length}\n`;
            summary += `âŒ Failed: ${failed.length}\n`;
            summary += `â­ï¸ Skipped: ${skipped.length}\n\n`;
            
            if (failed.length > 0) {
              summary += '### Failed Checks\n';
              failed.forEach(j => summary += `- âŒ ${j.name}\n`);
              summary += '\n';
            }
            
            if (passed.length === jobs.length - skipped.length && failed.length === 0) {
              summary += '### âœ¨ All checks passed! This PR is ready for review.\n';
            } else {
              summary += '### âš ï¸ Some checks need attention before merging.\n';
            }
            
            core.summary.addRaw(summary).write();
            
            if (failed.length > 0) {
              core.setFailed(`${failed.length} check(s) failed`);
            }
