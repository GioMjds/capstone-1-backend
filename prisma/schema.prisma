generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum PreferenceCategory {
  UI
  NOTIFICATION
  SECURITY
  COMPLIANCE
  ACCOUNT
  ACTIVITY
}

model User {
  id              String           @id @db.VarChar(12)
  firstName       String
  lastName        String
  email           String           @unique
  password        String
  phone           String?
  role            Roles            @default(USER)
  isActive        Boolean          @default(true)
  isEmailVerified Boolean          @default(false)
  userPreferences UserPreferences?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  isArchived      ArchivedUsers[]  @relation("ArchivedUserRelation")
}

model ArchivedUsers {
  id         String   @id @db.VarChar(12)
  userId     String   @unique
  archivedAt DateTime @default(now())
  user       User     @relation("ArchivedUserRelation", fields: [userId], references: [id])
}

model UserPreferences {
  id                   String                    @id @db.VarChar(12)
  userId               String                    @unique
  uiPreferences        Json                      @default("{}")
  notificationSettings UserNotificationSettings?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  user                 User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  securitySettings     UserSecuritySettings?
  complianceSettings   UserComplianceSettings?
  preferenceAuditLogs  PreferenceAuditLog[]
  accountControl       AccountControlSettings?
  activeSessions       ActiveSession[]
  trustedDevices       TrustedDevice[]
  activityLogs         ActivityLog[]
  loginHistory         LoginHistory[]
  dataOwnership        DataOwnershipSettings?
  privacySettings      PrivacySettings?
}

model UserNotificationSettings {
  id                 String          @id @db.VarChar(12)
  userPreferencesId  String          @unique
  emailNotifications Boolean         @default(true)
  pushNotifications  Boolean         @default(false)
  smsNotifications   Boolean         @default(false)
  preferences        Json            @default("{}")
  emailByCategory    Json            @default("{}")
  pushByCategory     Json            @default("{}")
  smsAlerts          Json            @default("{}")
  quietHoursStart    String?
  quietHoursEnd      String?
  marketingOptIn     Boolean         @default(false)
  digestFrequency    String          @default("daily")
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  userPreferences    UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)
}

model AccountControlSettings {
  id                  String          @id @db.VarChar(12)
  userPreferencesId   String          @unique
  deactivated         Boolean         @default(false)
  deactivatedAt       DateTime?
  deletionRequested   Boolean         @default(false)
  deletionRequestedAt DateTime?
  recoveryToken       String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  userPreferences     UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)
}

model ActiveSession {
  id                String          @id @db.VarChar(12)
  userPreferencesId String
  sessionId         String
  ipAddress         String?
  userAgent         String?
  lastSeen          DateTime        @default(now())
  createdAt         DateTime        @default(now())
  userPreferences   UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)

  @@index([userPreferencesId])
  @@index([lastSeen])
}

model TrustedDevice {
  id                String          @id @db.VarChar(12)
  userPreferencesId String
  deviceId          String
  deviceName        String?
  lastUsed          DateTime        @default(now())
  createdAt         DateTime        @default(now())
  userPreferences   UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)

  @@index([userPreferencesId])
}

model UserSecuritySettings {
  id                String             @id @db.VarChar(12)
  userPreferencesId String             @unique
  twoFactorEnabled  Boolean            @default(false)
  twoFactorMethod   String?
  passwordChangedAt DateTime?
  activeSessions    Json               @default("[]")
  trustedDevices    Json               @default("[]")
  passkeysEnabled   Boolean            @default(false)
  ipRestrictions    Json               @default("[]")
  loginAlerts       Json               @default("{}")
  suspiciousActivityAlerts Json         @default("{}")
  backupCodes       Json               @default("[]")
  sessionExpiration Int                @default(3600)
  passwordRotationReminder Int          @default(90)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  userPreferences   UserPreferences    @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)
  securityAuditLogs SecurityAuditLog[]
}

model UserComplianceSettings {
  id                   String               @id @db.VarChar(12)
  userPreferencesId    String               @unique
  dataShareConsent     Boolean              @default(false)
  dataRetentionMonths  Int                  @default(12)
  allowAccountDeletion Boolean              @default(true)
  auditLogPreference   String               @default("full")
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  userPreferences      UserPreferences      @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)
  complianceAuditLogs  ComplianceAuditLog[]
}

model PreferenceAuditLog {
  id                String          @id @db.VarChar(12)
  userPreferencesId String
  category          String
  field             String
  oldValue          Json?
  newValue          Json
  changedBy         String
  changeReason      String?
  createdAt         DateTime        @default(now())
  userPreferences   UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)

  @@index([userPreferencesId])
  @@index([createdAt])
}

model SecurityAuditLog {
  id                 String               @id @db.VarChar(12)
  securitySettingsId String
  event              String
  details            Json
  ipAddress          String?
  userAgent          String?
  createdAt          DateTime             @default(now())
  securitySettings   UserSecuritySettings @relation(fields: [securitySettingsId], references: [id], onDelete: Cascade)

  @@index([securitySettingsId])
  @@index([createdAt])
}

model ActivityLog {
  id                String          @id @db.VarChar(12)
  userPreferencesId String
  activityType      String
  action            String
  details           Json
  ipAddress         String?
  userAgent         String?
  timestamp         DateTime        @default(now())
  userPreferences   UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)

  @@index([userPreferencesId])
  @@index([timestamp])
}

model LoginHistory {
  id                String          @id @db.VarChar(12)
  userPreferencesId String
  ipAddress         String?
  userAgent         String?
  deviceName        String?
  loginMethod       String?
  loginAt           DateTime        @default(now())
  logoutAt          DateTime?
  duration          Int?
  userPreferences   UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)

  @@index([userPreferencesId])
  @@index([loginAt])
}

model DataOwnershipSettings {
  id                   String          @id @db.VarChar(12)
  userPreferencesId    String          @unique
  exportFormat         String          @default("json")
  dataRetentionDays    Int             @default(365)
  allowAutoDelete      Boolean         @default(false)
  allowDataAnonymization Boolean       @default(false)
  dataExportRequests   Json            @default("[]")
  dataDeletionRequests Json            @default("[]")
  dataCorrections      Json            @default("[]")
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  userPreferences      UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)
}

model PrivacySettings {
  id                     String          @id @db.VarChar(12)
  userPreferencesId      String          @unique
  profileVisibility      String          @default("private")
  activityVisibility     Json            @default("{}")
  fieldLevelVisibility   Json            @default("{}")
  onlinePresence         String          @default("hidden")
  allowPublicProfile     Boolean         @default(false)
  allowSearchEngineIndex Boolean         @default(false)
  allowThirdPartySharing Boolean         @default(false)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  userPreferences        UserPreferences @relation(fields: [userPreferencesId], references: [id], onDelete: Cascade)
}

model ComplianceAuditLog {
  id                   String                 @id @db.VarChar(12)
  complianceSettingsId String
  event                String
  action               String
  details              Json
  createdAt            DateTime               @default(now())
  complianceSettings   UserComplianceSettings @relation(fields: [complianceSettingsId], references: [id], onDelete: Cascade)

  @@index([complianceSettingsId])
  @@index([createdAt])
}

enum Roles {
  ADMIN
  USER
}
